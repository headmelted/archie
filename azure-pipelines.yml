# Docker image
# Build a Docker image to run, deploy, or push to a container registry.
# Add steps that use Docker Compose, tag images, push to a registry, run an image, and more:
# https://docs.microsoft.com/vsts/pipelines/languages/docker

jobs:
- job: 'hybrid_armhf'
  pool:
    vmImage: 'Ubuntu 16.04'
  variables:
    COBBLER_DOCKER_IMAGE: "headmelted/cobbler"
    COBBLER_ARCH: "armhf"
    COBBLER_STRATEGY: "hybrid"
  steps:
  - script: |
      export COBBLER_DOCKER_TAG="$COBBLER_STRATEGY-$COBBLER_ARCH"
      echo "Creating rootfs directory";
      mkdir rootfs;
      if [ "${COBBLER_STRATEGY}" == "hybrid" ] || [ "${COBBLER_STRATEGY}" == "emulate" ]; then
        echo "Downloading rootfs from prebootstrap for [${COBBLER_STRATEGY}] image";
        wget -c "https://github.com/headmelted/prebootstrap/releases/download/Oct-18/prebootstrap_stretch_minbase_${COBBLER_ARCH}_rootfs.tar.gz" -O - | sudo tar -xz -C rootfs
      fi
      echo "Performing first stage image build";
      sudo bash -c "IMAGE_NAME=${COBBLER_DOCKER_IMAGE} && COBBLER_STRATEGY=${COBBLER_STRATEGY} && COBBLER_ARCH=${COBBLER_ARCH} && DOCKER_TAG=${COBBLER_DOCKER_TAG} && . ./hooks/build";
      echo "Logging [$(DOCKER_LOGIN)] into docker hub";
      docker login -u $(DOCKER_LOGIN) -p $(DOCKER_PASSWORD);
      echo "Pushing image to docker hub";
      docker push ${COBBLER_DOCKER_IMAGE};
