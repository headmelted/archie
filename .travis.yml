sudo: required
dist: trusty
language: generic
services:
  - docker
cache:
  directories:
  - .cache
branches:
  only:
    - master

env:
  - COBBLER_DOCKER_TAG=hybrid-armhf COBBLER_HOME=$(pwd)
    
notifications:
  email: false

script:
  - cat /etc/apt/sources.list;
  - exit
  - echo "Current environment is:"
  - pwd
  - echo "Current home is:"
  - echo $COBBLER_HOME
  - echo "Setting Cobbler environment";
  - . ./kitchen/env/linux/setup.sh;
  - echo "Installing base Cobbler dependencies";
  - sudo apt-get install -y debootstrap fakechroot fakeroot proot qemu qemu-user-static;
  - echo "Creating rootfs";
  - mkdir rootfs;
  - echo "Using debootstrap --foreign to create rootfs for [$COBBLER_ARCH] jail"
  - fakeroot debootstrap --foreign --verbose --arch=$COBBLER_ARCH --variant=minbase stretch rootfs;
  - echo "Creating kitchen directory inside cleanroom user /home";
  - mkdir rootfs/home/kitchen;
  - echo "Entering [$COBBLER_ARCH] cleanroom (proot) to execute second stage of debootstrap";
  - sudo proot -b /dev -b /proc -b /sys -b $COBBLER_HOME/kitchen:/home/kitchen -q qemu-$COBBLER_QEMU_ARCH-static rootfs uname -a && sudo dpkg --configure -a && sudo apt-get update -yq;
  - echo "Performing first stage image build";
  - sudo bash -c "export IMAGE_NAME=headmelted/cobbler:$COBBLER_DOCKER_TAG && export DOCKER_TAG=$COBBLER_DOCKER_TAG && . ./hooks/build";
  
after_success:
  - echo "Logging into docker hub";
  - docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD;
  - echo "Pushing image to docker hub";
  - docker push headmelted/cobbler:$COBBLER_DOCKER_TAG;
